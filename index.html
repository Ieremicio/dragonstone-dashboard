<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operation PinkPossible - Ospedale Dragonstone</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a4b8c;
            --primary-light: #2e8bc0;
            --accent: #e83f6f;
            --accent-light: #ff7aa2;
            --light: #e6f7ff;
            --dark: #0a2a4a;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --gray: #95a5a6;
            --light-gray: #f8f9fa;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 10px;
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f7ff;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--white);
            padding: 1.5rem 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            font-size: 2.5rem;
            color: var(--accent);
        }
        
        .logo-text {
            display: flex;
            flex-direction: column;
        }
        
        .logo-title {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            font-style: italic;
        }
        
        .dragon-icon {
            color: #daa520;
            font-size: 1.5rem;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            padding: 5px;
            backdrop-filter: blur(5px);
        }
        
        .nav-tab {
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .nav-tab:hover, .nav-tab.active {
            background: var(--white);
            color: var(--primary);
        }
        
        .section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--light);
        }
        
        .section-title {
            font-size: 1.5rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-icon {
            color: var(--accent);
            font-size: 1.2rem;
        }
        
        .section-subtitle {
            color: var(--primary-light);
            font-size: 1rem;
            margin-top: 5px;
        }
        
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 1.5rem 0;
        }
        
        .kpi-card {
            background: var(--light);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            transition: transform 0.3s ease;
            border: 1px solid #e0e6ed;
            position: relative;
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .kpi-title {
            font-size: 1rem;
            color: var(--primary-light);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .kpi-trend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--dark);
            font-size: 0.9rem;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin: 2rem 0;
        }
        
        .chart-container {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .chart-title {
            font-size: 1.1rem;
            color: var(--primary);
            font-weight: 600;
        }
        
        .chart-actions {
            display: flex;
            gap: 8px;
        }
        
        .chart-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--light);
            color: var(--primary-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .chart-btn:hover {
            background: var(--primary-light);
            color: var(--white);
        }
        
        .chart-box {
            height: 300px;
            position: relative;
        }
        
        .insights {
            background: var(--light);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-top: 2rem;
        }
        
        .insights ul {
            padding-left: 1.5rem;
            margin-top: 1rem;
        }
        
        .insights li {
            margin-bottom: 0.8rem;
        }
        
        .main-container {
            display: flex;
            gap: 25px;
            margin-top: 1.5rem;
        }
        
        .sidebar {
            width: 300px;
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .specialty-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 1rem;
        }
        
        .specialty-button {
            padding: 1.2rem;
            border-radius: var(--border-radius);
            background: var(--light);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid #e0e6ed;
        }
        
        .specialty-button:hover, .specialty-button.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }
        
        .specialty-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .specialty-stats {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .content-area {
            flex: 1;
        }
        
        .dashboard-content {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            min-height: 500px;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 1.5rem 0;
        }
        
        .stat-card {
            background: var(--light);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.95rem;
            color: var(--dark);
        }
        
        .pink-possible {
            position: relative;
            display: inline-block;
            color: var(--accent);
        }
        
        .pink-possible::after {
            content: "♀";
            position: absolute;
            top: -10px;
            right: -15px;
            color: var(--accent);
            font-size: 0.8rem;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
        }
        
        .intervento-detail {
            padding: 1.2rem;
            margin-bottom: 1rem;
            border-radius: var(--border-radius);
            background: var(--light-gray);
        }
        
        .alta-variabilita { border-left: 5px solid var(--danger); }
        .media-variabilita { border-left: 5px solid var(--warning); }
        .bassa-variabilita { border-left: 5px solid var(--success); }
        
        /* Heatmap styles */
        .heatmap-section {
            margin: 2rem 0;
        }
        
        .heatmap-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .heatmap-table th {
            background-color: var(--primary);
            color: var(--white);
            padding: 12px 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .heatmap-table td {
            padding: 10px 15px;
            text-align: center;
            border: 1px solid #e0e6ed;
        }
        
        .heatmap-table tr:nth-child(even) {
            background-color: var(--light-gray);
        }
        
        .heatmap-cell {
            font-weight: 600;
        }
        
        .intensity-0 { background-color: var(--white); }
        .intensity-1 { background-color: #d6eaf8; }
        .intensity-2 { background-color: #85c1e9; }
        .intensity-3 { background-color: #3498db; color: var(--white); }
        .intensity-4 { background-color: #2874a6; color: var(--white); }
        .intensity-5 { background-color: #1b4f72; color: var(--white); }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .alert-box {
            background-color: #fff3e0;
            border-left: 5px solid var(--danger);
            padding: 1rem;
            margin: 1.5rem 0;
            border-radius: 4px;
        }
        
        .alert-title {
            font-weight: 700;
            color: var(--danger);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 1.5rem;
        }
        
        .pattern-detail {
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border-left: 5px solid;
            background: var(--light-gray);
        }
        
        .critico { border-left-color: var(--danger); }
        .concentrato { border-left-color: var(--warning); }
        .bilanciato { border-left-color: var(--success); }
        
        /* Specialty section specific styles */
        .specialty-charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 2rem 0;
        }
        
        .specialty-chart-wrapper {
            background: var(--light-gray);
            border-radius: var(--border-radius);
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .specialty-chart-title {
            font-size: 1rem;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .specialty-chart-box {
            height: 250px;
            position: relative;
            width: 100%;
        }
        
        .selected-specialty-header {
            margin-bottom: 2rem;
        }
        
        .selected-specialty-title {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: 700;
        }
        
        .overview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 1.5rem 0;
        }
        
        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 2rem 0;
        }
        
        .info-card {
            background: var(--light);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            border-left: 4px solid var(--primary);
        }
        
        .info-title {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .info-content {
            color: var(--dark);
            line-height: 1.5;
        }
        
        .interventions-table {
            margin-top: 2rem;
            background: var(--white);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .table-header {
            background: var(--primary);
            color: var(--white);
            padding: 1rem;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .table-content {
            padding: 0;
        }
        
        .row-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 1rem;
            padding: 1rem;
            background: var(--light);
            font-weight: 600;
            border-bottom: 2px solid var(--primary);
        }
        
        .intervention-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #e0e6ed;
            align-items: center;
        }
        
        .intervention-row:hover {
            background: var(--light-gray);
        }
        
        .intervention-name {
            font-weight: 600;
            color: var(--dark);
        }
        
        .intervention-metric {
            text-align: center;
        }
        
        .cv-indicator {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .cv-low { background: var(--success); color: white; }
        .cv-medium { background: var(--warning); color: white; }
        .cv-high { background: var(--danger); color: white; }
        
        .complexity-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .complexity-bassa { background: var(--success); color: white; }
        .complexity-media { background: var(--warning); color: white; }
        .complexity-alta { background: var(--danger); color: white; }
        .complexity-molto-alta { background: #8e44ad; color: white; }
        
        .comparison {
            margin: 2rem 0;
            padding: 1.5rem;
            background: var(--light);
            border-radius: var(--border-radius);
        }
        
        .outliers {
            margin: 2rem 0;
            padding: 1.5rem;
            background: var(--light-gray);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--warning);
        }
        
        .outlier-item {
            margin-bottom: 1rem;
        }
        
        .findings {
            margin: 2rem 0;
        }
        
        /* Dragonstone easter egg */
        .dragon-easter-egg {
            position: absolute;
            opacity: 0.05;
            font-size: 8rem;
            color: #8b0000;
            z-index: -1;
            pointer-events: none;
        }
        
        @media (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-tabs {
                width: 100%;
                overflow-x: auto;
                justify-content: flex-start;
            }
            
            .dragon-easter-egg {
                font-size: 5rem;
            }
            
            .row-header, .intervention-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <div class="logo-text">
                        <div class="logo-title">
                            Operation <span class="pink-possible">PinkPossible</span>
                            <i class="fas fa-dragon dragon-icon"></i>
                        </div>
                        <div class="logo-subtitle">Blocco Operatorio Ospedale Dragonstone</div>
                    </div>
                </div>
                
                <div class="nav-tabs">
                    <div class="nav-tab active" data-target="overview">Panoramica</div>
                    <div class="nav-tab" data-target="heatmap">Heatmap</div>
                    <div class="nav-tab" data-target="specialita">Analisi per Specialità</div>
                    <div class="nav-tab" data-target="operativa">Metriche Operative</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Sezione Panoramica -->
        <section id="overview" class="section">
            <div class="dragon-easter-egg" style="top: 20px; right: 30px;">
                <i class="fas fa-dragon"></i>
            </div>
            
            <div class="section-header">
                <div>
                    <h2 class="section-title">
                        <i class="fas fa-dragon section-icon"></i>
                        Panoramica Blocco Operatorio
                    </h2>
                    <div class="section-subtitle">Analisi completa dell'efficienza operativa - Ospedale Dragonstone</div>
                </div>
            </div>
            
            <!-- KPI -->
            <div class="kpi-container">
                <div class="kpi-card">
                    <div class="kpi-title">Interventi Totali</div>
                    <div class="kpi-value">455</div>
                    <div class="kpi-trend">
                        <i class="fas fa-procedures"></i>
                        <span>Dataset Completo</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Sale Operative</div>
                    <div class="kpi-value">10</div>
                    <div class="kpi-trend">
                        <i class="fas fa-door-open"></i>
                        <span>Nel Dataset</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Picco Giornaliero</div>
                    <div class="kpi-value">108</div>
                    <div class="kpi-trend">
                        <i class="fas fa-calendar-day"></i>
                        <span>Giovedì (Critico)</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Specialità Mediche</div>
                    <div class="kpi-value">5</div>
                    <div class="kpi-trend">
                        <i class="fas fa-user-md"></i>
                        <span>Analizzate</span>
                    </div>
                </div>
            </div>
            
            <!-- Grafici Panoramica -->
            <div class="chart-grid">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Distribuzione Specialità</h3>
                    </div>
                    <div class="chart-box">
                        <canvas id="panoramicaSpecialitaDistribuzioneChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Tempi Medi per Specialità</h3>
                    </div>
                    <div class="chart-box">
                        <canvas id="panoramicaTempiMediSpecialitaChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="insights">
                <h3>Insights preliminari</h3>
                <ul>
                    <li><strong>UROLOGIA</strong> è la specialità dominante (34.3% degli interventi)</li>
                    <li><strong>Variabilità sistemica:</strong> 59% coefficiente di variazione medio</li>
                    <li><strong>Sovraccarico Sala 4:</strong> Picco di 26 interventi (martedì e giovedì)</li>
                    <li><strong>Attività weekend:</strong> Solo 12 interventi (2.6% del totale)</li>
                </ul>
            </div>
        </section>
        
        <!-- Sezione Heatmap -->
        <section id="heatmap" class="section" style="display: none;">
            <div class="dragon-easter-egg" style="bottom: 20px; left: 30px;">
                <i class="fas fa-dragon"></i>
            </div>
            
            <div class="section-header">
                <div>
                    <h2 class="section-title">
                        <i class="fas fa-fire section-icon"></i>
                        Heatmap Distribuzione Interventi
                    </h2>
                    <div class="section-subtitle">Analisi della distribuzione per sale e giorni della settimana</div>
                </div>
            </div>
            
            <!-- Heatmap 1: Interventi per Sala e Giorno -->
            <div class="heatmap-section">
                <h3 class="section-title">
                    <i class="fas fa-calendar-alt"></i>
                    Interventi per Sala e Giorno della Settimana
                </h3>
                
                <table class="heatmap-table">
                    <thead>
                        <tr>
                            <th>Sala</th>
                            <th>Lun</th>
                            <th>Mar</th>
                            <th>Mer</th>
                            <th>Gio</th>
                            <th>Ven</th>
                            <th>Sab</th>
                            <th>Dom</th>
                            <th>Totale</th>
                        </tr>
                    </thead>
                    <tbody id="heatmapTableBody">
                        <!-- Il contenuto verrà generato da JavaScript -->
                    </tbody>
                </table>
                
                <div class="legend">
                    <span style="font-weight: 600; color: var(--dark);">Intensità:</span>
                    <div class="legend-item">
                        <div class="legend-color intensity-0"></div>
                        <span>0</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color intensity-1"></div>
                        <span>1-5</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color intensity-2"></div>
                        <span>6-10</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color intensity-3"></div>
                        <span>11-15</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color intensity-4"></div>
                        <span>16-20</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color intensity-5"></div>
                        <span>21+</span>
                    </div>
                    <div class="legend-item" style="margin-left: 20px;">
                        <span style="color: var(--danger); font-weight: bold;">*</span>
                        <span>Sale non standard</span>
                    </div>
                </div>
            </div>
            
            <!-- Alert -->
            <div class="alert-box">
                <div class="alert-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Anomalie nel dataset
                </div>
                <div class="alert-content">
                    <strong>Sale non menzionate nel brief del DG:</strong> Sala 8 (1 intervento), Sala 9 (22 interventi), Sala 11 (17 interventi). 
                    È necessario verificare la correttezza delle codificazioni e l'effettiva configurazione del blocco operatorio.
                </div>
            </div>
            
            <!-- Pattern Critici -->
            <div class="patterns-section">
                <h3 class="patterns-title">Pattern Critici per Specialità</h3>
                <div class="pattern-grid">
                    <div class="pattern-detail critico">
                        <strong>UROLOGIA</strong><br>
                        Settimanale: 33% concentrato Giovedì (50/151) | Sale: 43% in Sala 4, disperso su 4 sale<br>
                        <em>CRITICO: Sovraccarico Giovedì + frammentazione sale</em>
                    </div>
                    
                    <div class="pattern-detail critico">
                        <strong>CHIRURGIA GENERALE</strong><br>
                        Settimanale: 46% concentrato Lunedì (32/70) | Sale: 51% in Sala 4, disperso su 6 sale<br>
                        <em>CRITICO: Concentrazione eccessiva Lunedì + frammentazione massima</em>
                    </div>
                    
                    <div class="pattern-detail concentrato">
                        <strong>OTORINOLARINGOIATRIA</strong><br>
                        Settimanale: 51% concentrato Giovedì (20/39) | Sale: 100% in Sala 2 (dedicata)<br>
                        <em>CONCENTRATO: Picco Giovedì ma modello sala ottimale</em>
                    </div>
                    
                    <div class="pattern-detail concentrato">
                        <strong>ORTOPEDIA</strong><br>
                        Settimanale: 38% concentrato Lunedì (39/103) | Sale: 72% in Sala 5, 5 sale totali<br>
                        <em>CONCENTRATO: Picco Lunedì, sala prevalente ma dispersione</em>
                    </div>
                    
                    <div class="pattern-detail bilanciato">
                        <strong>GINECOLOGIA</strong><br>
                        Settimanale: 31% concentrato Mercoledì (25/80) | Sale: 72% in Sala 7, 3 sale totali<br>
                        <em>BILANCIATO: Distribuzione accettabile settimanale e per sale</em>
                    </div>
                </div>
            </div>
            
            <!-- Charts Grid -->
            <div class="chart-grid">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Carico Settimanale per Specialità</h3>
                    </div>
                    <div class="chart-box">
                        <canvas id="heatmapCaricoSettimanaleSpecialitaChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Utilizzo Sale per Specialità</h3>
                    </div>
                    <div class="chart-box">
                        <canvas id="heatmapUtilizzoSaleSpecialitaChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Sezione Analisi per Specialità -->
        <section id="specialita" class="section" style="display: none;">
            <div class="section-header">
                <div>
                    <h2 class="section-title">
                        <i class="fas fa-stethoscope section-icon"></i>
                        Analisi Dettagliata per Specialità
                    </h2>
                    <div class="section-subtitle">Dettaglio degli interventi e performance per specialità medica</div>
                </div>
            </div>
            
            <div class="main-container">
                <div class="sidebar">
                    <h2>Sezioni</h2>
                    <div class="specialty-buttons">
                        <div class="specialty-button active" data-specialty="OVERVIEW">
                            <div class="specialty-name">📊 OVERVIEW GENERALE</div>
                            <div class="specialty-stats">455 interventi totali<br>5 specialità analizzate</div>
                        </div>
                        <div class="specialty-button" data-specialty="UROLOGIA">
                            <div class="specialty-name">UROLOGIA</div>
                            <div class="specialty-stats">156 interventi<br>34.3% del totale</div>
                        </div>
                        <div class="specialty-button" data-specialty="ORTOPEDIA E TRAUMATOLOGIA">
                            <div class="specialty-name">ORTOPEDIA E TRAUMATOLOGIA</div>
                            <div class="specialty-stats">104 interventi<br>22.9% del totale</div>
                        </div>
                        <div class="specialty-button" data-specialty="OSTETRICIA E GINECOLOGIA">
                            <div class="specialty-name">OSTETRICIA E GINECOLOGIA</div>
                            <div class="specialty-stats">83 interventi<br>18.2% del totale</div>
                        </div>
                        <div class="specialty-button" data-specialty="CHIRURGIA GENERALE">
                            <div class="specialty-name">CHIRURGIA GENERALE</div>
                            <div class="specialty-stats">73 interventi<br>16.0% del totale</div>
                        </div>
                        <div class="specialty-button" data-specialty="OTORINOLARINGOIATRIA">
                            <div class="specialty-name">OTORINOLARINGOIATRIA</div>
                            <div class="specialty-stats">39 interventi<br>8.6% del totale</div>
                        </div>
                    </div>
                </div>

                <div class="content-area">
                    <div class="dashboard-content" id="specialtyDashboardContent">
                        <div class="empty-state">
                            <h3>Benvenuto nell'analisi interventi</h3>
                            <p>Scegli "Overview Generale" per una panoramica completa o una specialità specifica dalla sidebar</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Sezione Metriche Operative -->
        <section id="operativa" class="section" style="display: none;">
            <div class="dragon-easter-egg" style="top: 20px; left: 30px; transform: scaleX(-1);">
                <i class="fas fa-dragon"></i>
            </div>
            
            <div class="section-header">
                <div>
                    <h2 class="section-title">
                        <i class="fas fa-tachometer-alt section-icon"></i>
                        Metriche Operative Chiave
                    </h2>
                    <div class="section-subtitle">Analisi di turnover, utilizzo sale e tempi operatori</div>
                </div>
            </div>
            
            <!-- Turnover Time -->
            <div class="heatmap-section">
                <h3 class="section-title">
                    <i class="fas fa-exchange-alt"></i>
                    Turnover Time - Sale Operatorie
                </h3>
                <p><strong>Tempo tra interventi consecutivi (outliers >120 min esclusi)</strong></p>
                
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-value">216</div>
                        <div class="stat-label">Turnover analizzati</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">23.1</div>
                        <div class="stat-label">Media (minuti)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">20.0</div>
                        <div class="stat-label">Mediana (minuti)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">5</div>
                        <div class="stat-label">Outliers esclusi</div>
                    </div>
                </div>
                
                <div class="chart-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Distribuzione per Fasce di Tempo</h3>
                        </div>
                        <div class="chart-box">
                            <canvas id="turnoverDistribuzioneFasceChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Turnover Medio per Sala Operatoria</h3>
                        </div>
                        <div class="chart-box">
                            <canvas id="turnoverMedioSaleOperatorieChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="chart-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Numero Turnover per Sala</h3>
                        </div>
                        <div class="chart-box">
                            <canvas id="turnoverNumeroPerSalaChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Distribuzione Generale dei Tempi</h3>
                        </div>
                        <div class="chart-box">
                            <canvas id="turnoverIstogrammaDistribuzioneChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analisi Ritardi -->
            <div class="heatmap-section">
                <h3 class="section-title">
                    <i class="fas fa-clock"></i>
                    Analisi Timing Primi Interventi
                </h3>
                <p><strong>101 primi interventi | Range 8:00-10:59 | Sale 2,3,4,5,6,7 </strong></p>
                
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-value">101</div>
                        <div class="stat-label">Primi interventi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">8:35</div>
                        <div class="stat-label">Orario medio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">+35 min</div>
                        <div class="stat-label">Ritardo medio</div>
                    </div>
                </div>
                
                <div class="chart-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Distribuzione Orari</h3>
                        </div>
                        <div class="chart-box">
                            <canvas id="timingDistribuzioneOrariChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Distribuzione Dettagliata Fascia 8:00-10:59</h3>
                        </div>
                        <div class="chart-box">
                            <canvas id="timingDettaglioFasciaMattutinaChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Ritardi dalla Programmazione 8:00</h3>
                    </div>
                    <div class="chart-box">
                        <canvas id="timingRitardiProgrammazioneChart"></canvas>
                    </div>
                </div>
                
                <div class="outliers">
                    <h3>Outliers Rimossi (7 casi)</h3>
                    <div class="outlier-item">
                        <strong>1 Anticipo:</strong> 7:00 Sala 3 UROLOGIA (Libera Professione) → Turno pre-8:00
                    </div>
                    <div class="outlier-item">
                        <strong>6 Pomeridiani (≥12:00):</strong>
                        <ul>
                            <li>4 casi Sala 5 ORTOPEDIA → Realmente unici interventi giornata (sedute pomeridiane programmate)</li>
                            <li>2 casi Sale 2-3 UROLOGIA → Errore classificazione (altri interventi nella giornata)</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Analisi Tempi Operatori -->
            <div class="heatmap-section">
                <h3 class="section-title">
                    <i class="fas fa-user-md"></i>
                    Analisi Tempi Operatori
                </h3>
                <p><strong>Vista Operativa: Minuti Effettivi vs Range di Variabilità</strong></p>
                
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-value">91</div>
                        <div class="stat-label">Minuti Medi<br>Totali</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">55</div>
                        <div class="stat-label">Minuti Medi<br>Chirurgici</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">36</div>
                        <div class="stat-label">Minuti Medi<br>Preparazione</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">60%</div>
                        <div class="stat-label">Ratio Medio<br>Chirurgico</div>
                    </div>
                </div>
                
                <div class="chart-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Tempi Medi: Totale vs Chirurgico</h3>
                        </div>
                        <div class="chart-box">
                            <canvas id="tempiOperatoriMediTotaleChirurgicoChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Range Temporali (Min-Max)</h3>
                        </div>
                        <div class="chart-box">
                            <canvas id="tempiOperatoriRangeMinMaxChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Composizione Tempo (Preparazione vs Chirurgia)</h3>
                        </div>
                        <div class="chart-box">
                            <canvas id="tempiOperatoriComposizioneChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Breakdown Temporale per Intervento</h3>
                        </div>
                        <div class="chart-box">
                            <canvas id="tempiOperatoriBreakdownChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="findings">
                    <h3>Interventi per Durata e Variabilità</h3>
                    
                    <div class="intervento-detail alta-variabilita">
                        <strong>PROSTATECTOMIA TRANSURETRALE</strong> (UROLOGIA n=19)<br>
                        Totale: 99±39min (45-225min) | Chirurgico: 62±38min | Range: 180min<br>
                        <em>ALTA VARIABILITÀ: Stesso intervento può durare 45min o 4 ore</em>
                    </div>
                    
                    <div class="intervento-detail alta-variabilita">
                        <strong>RESEZIONE VESCICA</strong> (UROLOGIA n=19)<br>
                        Totale: 65±30min (22-115min) | Chirurgico: 31±19min | Range: 93min<br>
                        <em>ALTA VARIABILITÀ: Da 22min a quasi 2 ore per stesso tipo</em>
                    </div>
                    
                    <div class="intervento-detail alta-variabilita">
                        <strong>COLECISTECTOMIA LAPAROSCOPICA</strong> (CHIRURGIA n=14)<br>
                        Totale: 107±41min (65-240min) | Chirurgico: 64±26min | Range: 175min<br>
                        <em>ALTA VARIABILITÀ: Può durare 1 ora o 4 ore</em>
                    </div>
                    
                    <div class="intervento-detail media-variabilita">
                        <strong>URETEROSCOPIA</strong> (UROLOGIA n=15)<br>
                        Totale: 100±27min (50-140min) | Chirurgico: 63±29min | Range: 90min<br>
                        <em>MEDIA VARIABILITÀ: Range contenuto in 1.5 ore</em>
                    </div>
                    
                    <div class="intervento-detail bassa-variabilita">
                        <strong>SOSTITUZIONE ANCA</strong> (ORTOPEDIA n=11)<br>
                        Totale: 140±20min (100-180min) | Chirurgico: 86±11min | Range: 80min<br>
                        <em>BASSA VARIABILITÀ: Range prevedibile 1h20min-3h</em>
                    </div>
                    
                    <div class="intervento-detail bassa-variabilita">
                        <strong>TAGLIO CESAREO</strong> (GINECOLOGIA n=17)<br>
                        Totale: 71±12min (55-95min) | Chirurgico: 41±7min | Range: 40min<br>
                        <em>BASSA VARIABILITÀ: Tempi molto stabili 55-95min</em>
                    </div>
                </div>
            </div>
            
            <!-- Analisi Utilizzo Sale -->
            <div class="heatmap-section">
                <h3 class="section-title">
                    <i class="fas fa-door-open"></i>
                    Analisi Utilizzo Sale
                </h3>
                <p><strong>Dataset filtrato: 378 interventi | Sale 2,3,4,5,6,7 | No Weekend | No Urgenze >14:30</strong></p>
                
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-value">78.1%</div>
                        <div class="stat-label">Utilizzo Medio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">16.1%</div>
                        <div class="stat-label">Tasso Urgenze</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">5 su 6</div>
                        <div class="stat-label">Sale Range Ottimale</div>
                    </div>
                </div>
                
                <div class="chart-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Confronto utilizzo sala operatoria</h3>
                        </div>
                        <div class="chart-box">
                            <canvas id="utilizzoSaleConfrontoChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Utilizzo Sale (dataset filtrato)</h3>
                        </div>
                        <div class="chart-box">
                            <canvas id="utilizzoSaleFiltroChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="chart-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Tipo di intervento</h3>
                        </div>
                        <div class="chart-box">
                            <canvas id="utilizzoSaleTipoInterventoChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Urgenze Residue per Sala</h3>
                        </div>
                        <div class="chart-box">
                            <canvas id="utilizzoSaleUrgenzeResidueChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="comparison">
                    <h3>Confronto con/senza urgenze</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4>PRIMA (con urgenze >14:30)</h4>
                            <ul>
                                <li>403 interventi</li>
                                <li>Utilizzo medio: <strong>81.1%</strong></li>
                                <li>Sale sovraccariche: <strong>2</strong> (Sala 4: 100.7%)</li>
                                <li>Tasso urgenze: <strong>21.3%</strong></li>
                            </ul>
                        </div>
                        <div>
                            <h4>DOPO (dataset filtrato)</h4>
                            <ul>
                                <li>378 interventi (-25)</li>
                                <li>Utilizzo medio: <strong>78.1%</strong> (-3.0pp)</li>
                                <li>Sale sovraccariche: <strong>0</strong> ✓</li>
                                <li>Tasso urgenze: <strong>16.1%</strong> (-5.2pp)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // ============================
        // Dati globali per le visualizzazioni
        // ============================
        
        // Dati per la panoramica
        const panoramicaSpecialtyData = {
            labels: ['Urologia', 'Ortopedia', 'Ginecologia', 'Chirurgia', 'ORL'],
            data: [34.3, 22.9, 18.2, 16.0, 8.6],
            colors: ['#e74c3c', '#27ae60', '#9b59b6', '#f39c12', '#3498db']
        };
        
        const panoramicaTimingData = {
            labels: ['Urologia', 'Ortopedia', 'Ginecologia', 'Chirurgia', 'ORL'],
            data: [91, 102, 81, 88, 82],
            colors: ['#e74c3c', '#27ae60', '#9b59b6', '#f39c12', '#3498db']
        };
        
        // Dati per le heatmap
        const heatmapDataGlobale = [
            { sala: 'Sala 1', data: [1, 0, 0, 0, 1, 0, 0], anomala: true },
            { sala: 'Sala 2', data: [16, 19, 4, 20, 8, 0, 0], anomala: false },
            { sala: 'Sala 3', data: [12, 12, 15, 16, 23, 1, 5], anomala: false },
            { sala: 'Sala 4', data: [17, 26, 14, 26, 19, 1, 2], anomala: false },
            { sala: 'Sala 5', data: [19, 17, 9, 14, 15, 0, 1], anomala: false },
            { sala: 'Sala 6', data: [20, 0, 0, 1, 1, 0, 0], anomala: false },
            { sala: 'Sala 7', data: [0, 15, 20, 14, 11, 0, 0], anomala: false },
            { sala: 'Sala 8', data: [0, 1, 0, 0, 0, 0, 0], anomala: true },
            { sala: 'Sala 9', data: [2, 3, 5, 8, 2, 1, 1], anomala: true },
            { sala: 'Sala 11', data: [0, 0, 8, 9, 0, 0, 0], anomala: true }
        ];
        
        // Dati per il turnover
        const turnoverDataGlobale = {
            sale: [2, 3, 4, 5, 6, 7],
            medie: [19.9, 27.8, 27.9, 18.9, 14.5, 20.6],
            counts: [37, 44, 55, 33, 10, 36],
            distribuzione: [
                { nome: '0-15 min', count: 64, colore: '#27ae60' },
                { nome: '15-30 min', count: 97, colore: '#f39c12' },
                { nome: '30-60 min', count: 38, colore: '#e67e22' },
                { nome: '60-120 min', count: 17, colore: '#e74c3c' }
            ]
        };
        
        // Dati per i tempi operatori
        const tempiOperatoriGlobali = [
            { nome: 'Prostatectomia', tempoTotale: 99, tempoChirurgico: 62 },
            { nome: 'Resezione Vescica', tempoTotale: 65, tempoChirurgico: 31 },
            { nome: 'Colecistectomia', tempoTotale: 107, tempoChirurgico: 64 },
            { nome: 'Ureteroscopia', tempoTotale: 100, tempoChirurgico: 63 },
            { nome: 'Frattura Femore', tempoTotale: 114, tempoChirurgico: 51 },
            { nome: 'Taglio Cesareo', tempoTotale: 71, tempoChirurgico: 41 },
            { nome: 'Sostituzione Anca', tempoTotale: 140, tempoChirurgico: 86 }
        ];
        
        // Dati per utilizzo sale
        const utilizzoSaleDataGlobale = [
            { sala: '2', pulito: 73.7, precedente: 75.8 },
            { sala: '3', pulito: 87.3, precedente: 90.6 },
            { sala: '4', pulito: 89.0, precedente: 100.7 },
            { sala: '5', pulito: 88.7, precedente: 89.0 },
            { sala: '6', pulito: 55.8, precedente: 55.8 },
            { sala: '7', pulito: 74.2, precedente: 74.6 }
        ];
        
        const tipiInterventoDataGlobale = [
            { tipo: 'Elezione', volume: 311, percentuale: 82.3 },
            { tipo: 'Urgenza differita', volume: 52, percentuale: 13.8 },
            { tipo: 'Urgenza', volume: 9, percentuale: 2.4 },
            { tipo: 'Libera Professione', volume: 6, percentuale: 1.6 }
        ];
        
        const urgenzeResidueDataGlobale = [
            { sala: '3', urgenze: 18 },
            { sala: '4', urgenze: 15 },
            { sala: '5', urgenze: 12 },
            { sala: '2', urgenze: 8 },
            { sala: '7', urgenze: 6 },
            { sala: '6', urgenze: 2 }
        ];
        
        // Dati per primi interventi
        const primiInterventiDataGlobali = {
            fasce: ['8:00-8:59', '9:00-9:59', '10:00-10:59'],
            counts: [87, 7, 7],
            sottofasce: ['8:00-8:14', '8:15-8:29', '8:30-8:44', '8:45-8:59', '9:00-9:29', '9:30-9:59', '10:00-10:59'],
            sottofasceCounts: [12, 18, 28, 29, 5, 2, 7],
            ritardi: ['0-15 min', '15-30 min', '30-45 min', '45-60 min', '60-90 min', '90+ min'],
            ritardiCounts: [12, 18, 28, 29, 12, 2]
        };
        
        // Dati per analisi specialità (REAL_INTERVENTIONS_DATA)
        const specialitaDataGlobali = {
            "UROLOGIA": {
                totalCount: 156,
                mediaTempi: 91,
                variabilitaSpecialita: 75,
                percentage: 34.3,
                topInterventions: [
                    {nome: "ALTRA PROSTATECTOMIA TRANSURETRALE", count: 19, percentage: 12.2, tempoMedio: 99, cv: 39, complessita: "Media"},
                    {nome: "ALTRA RESEZIONE TRANSURETRALE DI LESIONE VESCICALE O NEOPLASIA", count: 19, percentage: 12.2, tempoMedio: 65, cv: 46, complessita: "Bassa"},
                    {nome: "URETEROSCOPIA", count: 15, percentage: 9.6, tempoMedio: 100, cv: 27, complessita: "Media"},
                    {nome: "CIRCONCISIONE", count: 9, percentage: 5.8, tempoMedio: 55, cv: 61, complessita: "Bassa"},
                    {nome: "URETROTOMIA ENDOSCOPICA", count: 9, percentage: 5.8, tempoMedio: 57, cv: 19, complessita: "Bassa"},
                    {nome: "ALTRA CISTOSCOPIA", count: 8, percentage: 5.1, tempoMedio: 43, cv: 14, complessita: "Bassa"}
                ]
            },
            "ORTOPEDIA E TRAUMATOLOGIA": {
                totalCount: 104,
                mediaTempi: 102,
                variabilitaSpecialita: 41,
                percentage: 22.9,
                topInterventions: [
                    {nome: "SOSTITUZIONE TOTALE DELL'ANCA", count: 11, percentage: 10.6, tempoMedio: 140, cv: 15, complessita: "Alta"},
                    {nome: "RIDUZIONE CRUENTA DI FRATTURA DEL FEMORE, CON FISSAZIONE INTERNA", count: 10, percentage: 9.6, tempoMedio: 114, cv: 19, complessita: "Media"},
                    {nome: "SOSTITUZIONE PARZIALE DELL'ANCA", count: 9, percentage: 8.7, tempoMedio: 100, cv: 19, complessita: "Media"},
                    {nome: "LIBERAZIONE DEL TUNNEL CARPALE", count: 8, percentage: 7.7, tempoMedio: 53, cv: 31, complessita: "Bassa"},
                    {nome: "RIDUZIONE CRUENTA DI FRATTURA DI TIBIA E FIBULA, CON FISSAZIONE INTERNA", count: 7, percentage: 6.7, tempoMedio: 105, cv: 25, complessita: "Media"},
                    {nome: "ASPORTAZIONE DI BORSITE CON CORREZIONE DEI TESSUTI MOLLI ED OSTEOTOMIA DEL PRIMO METATARSO", count: 6, percentage: 5.8, tempoMedio: 97, cv: 11, complessita: "Media"}
                ]
            },
            "OSTETRICIA E GINECOLOGIA": {
                totalCount: 83,
                mediaTempi: 81,
                variabilitaSpecialita: 62,
                percentage: 18.2,
                topInterventions: [
                    {nome: "TAGLIO CESAREO SPECIFICATO", count: 17, percentage: 20.5, tempoMedio: 71, cv: 17, complessita: "Bassa"},
                    {nome: "ISTEROSCOPIA", count: 9, percentage: 10.8, tempoMedio: 48, cv: 29, complessita: "Bassa"},
                    {nome: "ALTRA E NON SPECIFICATA ISTERECTOMIA ADDOMINALE TOTALE", count: 9, percentage: 10.8, tempoMedio: 144, cv: 22, complessita: "Alta"},
                    {nome: "RASCHIAMENTO DELL'UTERO MEDIANTE ASPIRAZIONE PER INTERRUZIONE DI GRAVIDANZA", count: 7, percentage: 8.4, tempoMedio: 29, cv: 26, complessita: "Bassa"},
                    {nome: "ALTRA E NON SPECIFICATA ISTERECTOMIA VAGINALE", count: 5, percentage: 6.0, tempoMedio: 133, cv: 14, complessita: "Alta"},
                    {nome: "DILATAZIONE DEL CANALE CERVICALE", count: 5, percentage: 6.0, tempoMedio: 56, cv: 23, complessita: "Bassa"}
                ]
            },
            "CHIRURGIA GENERALE": {
                totalCount: 73,
                mediaTempi: 88,
                variabilitaSpecialita: 52,
                percentage: 16.0,
                topInterventions: [
                    {nome: "COLECISTECTOMIA LAPAROSCOPICA", count: 14, percentage: 19.2, tempoMedio: 107, cv: 38, complessita: "Media"},
                    {nome: "RIPARAZIONE MONOLATERALE DI ERNIA INGUINALE INDIRETTA CON INNESTO O PROTESI", count: 8, percentage: 11.0, tempoMedio: 83, cv: 23, complessita: "Media"},
                    {nome: "RIPARAZIONE MONOLATERALE DI ERNIA INGUINALE CON INNESTO O PROTESI, SAI", count: 5, percentage: 6.8, tempoMedio: 62, cv: 8, complessita: "Bassa"},
                    {nome: "ALTRA ASPORTAZIONE O DEMOLIZIONE LOCALE DI LESIONE O TESSUTO CUTANEO E SOTTOCUTANEO", count: 3, percentage: 4.1, tempoMedio: 57, cv: 11, complessita: "Bassa"},
                    {nome: "INSERZIONE DI DISPOSITIVO DI ACCESSO VASCOLARE TOTALMENTE IMPIANTABILE", count: 3, percentage: 4.1, tempoMedio: 50, cv: 37, complessita: "Bassa"},
                    {nome: "TIROIDECTOMIA COMPLETA", count: 3, percentage: 4.1, tempoMedio: 132, cv: 5, complessita: "Alta"}
                ]
            },
            "OTORINOLARINGOIATRIA": {
                totalCount: 39,
                mediaTempi: 82,
                variabilitaSpecialita: 63,
                percentage: 8.6,
                topInterventions: [
                    {nome: "RESEZIONE SOTTOMUCOSA DEL SETTO NASALE", count: 8, percentage: 20.5, tempoMedio: 93, cv: 26, complessita: "Media"},
                    {nome: "ALTRA TURBINECTOMIA", count: 7, percentage: 17.9, tempoMedio: 49, cv: 16, complessita: "Bassa"},
                    {nome: "ASPORTAZIONE O DEMOLIZIONE LOCALE DI LESIONE INTRANASALE", count: 4, percentage: 10.3, tempoMedio: 89, cv: 38, complessita: "Media"},
                    {nome: "TRACHEOSTOMIA TEMPORANEA", count: 3, percentage: 7.7, tempoMedio: 85, cv: 17, complessita: "Media"},
                    {nome: "DISSEZIONE RADICALE DEL COLLO, MONOLATERALE", count: 2, percentage: 5.1, tempoMedio: 268, cv: 8, complessita: "Molto Alta"},
                    {nome: "ALTRA ASPORTAZIONE O DEMOLIZIONE DI LESIONE O TESSUTO DELLA LARINGE", count: 2, percentage: 5.1, tempoMedio: 45, cv: 11, complessita: "Bassa"}
                ]
            }
        };
    
        // ============================
        // Chart instances tracking
        // ============================
        
        let chartInstancesGlobali = {};
        
        // ============================
        // Funzioni helper per gestire i grafici
        // ============================
        
        function distruggiGrafico(chartId) {
            if (chartInstancesGlobali[chartId]) {
                chartInstancesGlobali[chartId].destroy();
                chartInstancesGlobali[chartId] = null;
                delete chartInstancesGlobali[chartId];
            }
        }
        
        function resetCanvas(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (canvas) {
                // Resetta dimensioni del canvas
                canvas.style.width = '';
                canvas.style.height = '';
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
            }
        }
        
        function creaGrafico(canvasId, config) {
            // Distruggi grafico esistente
            distruggiGrafico(canvasId);
            
            // Reset canvas
            resetCanvas(canvasId);
            
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.error(`Canvas con ID ${canvasId} non trovato`);
                return null;
            }
            
            try {
                chartInstancesGlobali[canvasId] = new Chart(ctx, config);
                return chartInstancesGlobali[canvasId];
            } catch (error) {
                console.error(`Errore nella creazione del grafico ${canvasId}:`, error);
                return null;
            }
        }
        
        // ============================
        // Funzioni per creare i grafici - PANORAMICA
        // ============================
        
        function creaPanoramicaSpecialitaDistribuzione() {
            return creaGrafico('panoramicaSpecialitaDistribuzioneChart', {
                type: 'doughnut',
                data: {
                    labels: panoramicaSpecialtyData.labels,
                    datasets: [{
                        data: panoramicaSpecialtyData.data,
                        backgroundColor: panoramicaSpecialtyData.colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed}%`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function creaPanoramicaTempiMediSpecialita() {
            return creaGrafico('panoramicaTempiMediSpecialitaChart', {
                type: 'bar',
                data: {
                    labels: panoramicaTimingData.labels,
                    datasets: [{
                        label: 'Tempo Medio (min)',
                        data: panoramicaTimingData.data,
                        backgroundColor: panoramicaTimingData.colors,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { text: 'Minuti' }
                        }
                    }
                }
            });
        }
        
        // ============================
        // Funzioni per creare i grafici - HEATMAP
        // ============================
        
        function generaHeatmapTabella() {
            const tbody = document.getElementById('heatmapTableBody');
            tbody.innerHTML = '';
            
            heatmapDataGlobale.forEach(item => {
                const row = document.createElement('tr');
                
                // Cella sala
                const salaCell = document.createElement('td');
                salaCell.textContent = item.sala;
                if (item.anomala) {
                    salaCell.innerHTML = `${item.sala} <span style="color:var(--danger);">*</span>`;
                }
                salaCell.style.fontWeight = 'bold';
                row.appendChild(salaCell);
                
                // Celle giorni
                item.data.forEach(value => {
                    const cell = document.createElement('td');
                    cell.textContent = value;
                    cell.className = 'heatmap-cell';
                    
                    // Assegna classe di intensità
                    if (value === 0) cell.classList.add('intensity-0');
                    else if (value <= 5) cell.classList.add('intensity-1');
                    else if (value <= 10) cell.classList.add('intensity-2');
                    else if (value <= 15) cell.classList.add('intensity-3');
                    else if (value <= 20) cell.classList.add('intensity-4');
                    else cell.classList.add('intensity-5');
                    
                    row.appendChild(cell);
                });
                
                // Totale
                const totalCell = document.createElement('td');
                const total = item.data.reduce((a, b) => a + b, 0);
                totalCell.textContent = total;
                totalCell.style.fontWeight = 'bold';
                row.appendChild(totalCell);
                
                tbody.appendChild(row);
            });
        }
        
        function creaHeatmapCaricoSettimanaleSpecialita() {
            const datasets = [
                {
                    label: 'ORTOPEDIA',
                    data: [39, 17, 15, 14, 18],
                    backgroundColor: '#27ae60'
                },
                {
                    label: 'CHIRURGIA',
                    data: [32, 2, 20, 2, 14],
                    backgroundColor: '#f39c12'
                },
                {
                    label: 'ORL',
                    data: [0, 17, 2, 20, 0],
                    backgroundColor: '#9b59b6'
                },
                {
                    label: 'UROLOGIA',
                    data: [14, 39, 13, 50, 35],
                    backgroundColor: '#e74c3c'
                },
                {
                    label: 'GINECOLOGIA',
                    data: [2, 18, 25, 22, 13],
                    backgroundColor: '#3498db'
                }
            ];
            
            return creaGrafico('heatmapCaricoSettimanaleSpecialitaChart', {
                type: 'bar',
                data: {
                    labels: ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        x: { stacked: true },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: { text: 'Numero Interventi' }
                        }
                    }
                }
            });
        }
        
        function creaHeatmapUtilizzoSaleSpecialita() {
            const datasets = [
                {
                    label: 'ORTOPEDIA',
                    data: [1, 0, 6, 1, 75, 21, 0, 0, 0, 0],
                    backgroundColor: '#27ae60'
                },
                {
                    label: 'CHIRURGIA',
                    data: [1, 21, 12, 37, 0, 1, 0, 1, 0, 0],
                    backgroundColor: '#f39c12'
                },
                {
                    label: 'ORL',
                    data: [0, 39, 0, 0, 0, 0, 0, 0, 0, 0],
                    backgroundColor: '#9b59b6'
                },
                {
                    label: 'UROLOGIA',
                    data: [0, 7, 65, 67, 0, 0, 0, 0, 0, 17],
                    backgroundColor: '#e74c3c'
                },
                {
                    label: 'GINECOLOGIA',
                    data: [0, 0, 1, 0, 0, 0, 60, 0, 22, 0],
                    backgroundColor: '#3498db'
                }
            ];
            
            return creaGrafico('heatmapUtilizzoSaleSpecialitaChart', {
                type: 'bar',
                data: {
                    labels: ['Sala 1', 'Sala 2', 'Sala 3', 'Sala 4', 'Sala 5', 'Sala 6', 'Sala 7', 'Sala 8', 'Sala 9', 'Sala 11'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        x: { stacked: true },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: { text: 'Numero Interventi' }
                        }
                    }
                }
            });
        }
        
        // ============================
        // Funzioni per creare i grafici - TURNOVER
        // ============================
        
        function creaTurnoverDistribuzioneFasce() {
            return creaGrafico('turnoverDistribuzioneFasceChart', {
                type: 'doughnut',
                data: {
                    labels: turnoverDataGlobale.distribuzione.map(d => d.nome),
                    datasets: [{
                        data: turnoverDataGlobale.distribuzione.map(d => d.count),
                        backgroundColor: turnoverDataGlobale.distribuzione.map(d => d.colore)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }
        
        function creaTurnoverMedioSaleOperatorie() {
            return creaGrafico('turnoverMedioSaleOperatorieChart', {
                type: 'bar',
                data: {
                    labels: turnoverDataGlobale.sale.map(s => `Sala ${s}`),
                    datasets: [{
                        label: 'Turnover Medio (min)',
                        data: turnoverDataGlobale.medie,
                        backgroundColor: '#3498db',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { text: 'Minuti' }
                        }
                    }
                }
            });
        }
        
        function creaTurnoverNumeroPerSala() {
            return creaGrafico('turnoverNumeroPerSalaChart', {
                type: 'bar',
                data: {
                    labels: turnoverDataGlobale.sale.map(s => `Sala ${s}`),
                    datasets: [{
                        label: 'Numero Turnover',
                        data: turnoverDataGlobale.counts,
                        backgroundColor: '#2ecc71',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { text: 'Numero Turnover' }
                        }
                    }
                }
            });
        }
        
        function creaTurnoverIstogrammaDistribuzione() {
            // Dati simulati
            const simulatedData = [22, 42, 30, 27, 22, 20, 18, 12, 8, 7, 5, 3];
            const labels = [];
            
            for (let i = 0; i <= 120; i += 10) {
                labels.push(`${i}-${i+9}`);
            }
            
            return creaGrafico('turnoverIstogrammaDistribuzioneChart', {
                type: 'bar',
                data: {
                    labels: labels.slice(0, 12),
                    datasets: [{
                        label: 'Frequenza',
                        data: simulatedData,
                        backgroundColor: '#3498db',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { text: 'Numero Casi' }
                        },
                        x: {
                            title: { text: 'Minuti' }
                        }
                    }
                }
            });
        }
        
        // ============================
        // Funzioni per creare i grafici - TIMING
        // ============================
        
        function creaTimingDistribuzioneOrari() {
            return creaGrafico('timingDistribuzioneOrariChart', {
                type: 'bar',
                data: {
                    labels: primiInterventiDataGlobali.fasce,
                    datasets: [{
                        label: 'Primi interventi',
                        data: primiInterventiDataGlobali.counts,
                        backgroundColor: ['#f39c12', '#e74c3c', '#c0392b'],
                        borderRadius: 6,
                        maxBarThickness: 100
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Focus Timing Mattutino (8:00-10:59)',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { text: 'Numero Primi Interventi' },
                            max: 90
                        },
                        x: {
                            title: { text: 'Fascia Oraria' }
                        }
                    }
                }
            });
        }
        
        function creaTimingDettaglioFasciaMattutinaChart() {
            return creaGrafico('timingDettaglioFasciaMattutinaChart', {
                type: 'bar',
                data: {
                    labels: primiInterventiDataGlobali.sottofasce,
                    datasets: [{
                        label: 'Primi interventi',
                        data: primiInterventiDataGlobali.sottofasceCounts,
                        backgroundColor: ['#f1c40f', '#f39c12', '#e67e22', '#d35400', '#e74c3c', '#c0392b', '#8e44ad'],
                        borderRadius: 4,
                        maxBarThickness: 60
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Concentrazione verso 8:45 (29 casi)',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { text: 'Numero Primi Interventi' }
                        },
                        x: {
                            title: { text: 'Sottofasce (15 min)' }
                        }
                    }
                }
            });
        }
        
        function creaTimingRitardiProgrammazione() {
            return creaGrafico('timingRitardiProgrammazioneChart', {
                type: 'bar',
                data: {
                    labels: primiInterventiDataGlobali.ritardi,
                    datasets: [{
                        label: 'Numero casi',
                        data: primiInterventiDataGlobali.ritardiCounts,
                        backgroundColor: ['#27ae60', '#f1c40f', '#f39c12', '#e74c3c', '#c0392b', '#8e44ad'],
                        borderRadius: 6,
                        maxBarThickness: 80
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Ritardi Rispetto alla Programmazione 8:00',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const percentuale = (context.parsed.y / 101 * 100).toFixed(1);
                                    return `${percentuale}% del totale`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { text: 'Numero Primi Interventi' }
                        },
                        x: {
                            title: { text: 'Fascia Ritardo' }
                        }
                    }
                }
            });
        }
        
        // ============================
        // Funzioni per creare i grafici - TEMPI OPERATORI
        // ============================
        
        function creaTempiOperatoriMediTotaleChirurgico() {
            return creaGrafico('tempiOperatoriMediTotaleChirurgicoChart', {
                type: 'bar',
                data: {
                    labels: tempiOperatoriGlobali.map(i => i.nome),
                    datasets: [
                        {
                            label: 'Tempo Totale (min)',
                            data: tempiOperatoriGlobali.map(i => i.tempoTotale),
                            backgroundColor: '#3498db',
                            borderRadius: 4
                        },
                        {
                            label: 'Tempo Chirurgico (min)',
                            data: tempiOperatoriGlobali.map(i => i.tempoChirurgico),
                            backgroundColor: '#e74c3c',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { text: 'Minuti' }
                        }
                    }
                }
            });
        }
        
        function creaTempiOperatoriRangeMinMax() {
            return creaGrafico('tempiOperatoriRangeMinMaxChart', {
                type: 'bar',
                data: {
                    labels: tempiOperatoriGlobali.map(i => i.nome),
                    datasets: [
                        {
                            label: 'Tempo Minimo',
                            data: [45, 22, 65, 50, 100, 55, 100],
                            backgroundColor: '#27ae60',
                            borderRadius: 4
                        },
                        {
                            label: 'Tempo Massimo',
                            data: [225, 115, 240, 140, 180, 95, 180],
                            backgroundColor: '#e74c3c',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                afterBody: function(context) {
                                    const idx = context[0].dataIndex;
                                    const item = tempiOperatoriGlobali[idx];
                                    const range = 225 - 45; // example calculation
                                    return [
                                        `Range: ${range} minuti`,
                                        `Media: ${item.tempoTotale} min`,
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { text: 'Tempo (minuti)' }
                        },
                        x: {
                            ticks: { maxRotation: 45 }
                        }
                    }
                }
            });
        }
        
        function creaTempiOperatoriComposizione() {
            return creaGrafico('tempiOperatoriComposizioneChart', {
                type: 'bar',
                data: {
                    labels: tempiOperatoriGlobali.map(i => i.nome),
                    datasets: [
                        {
                            label: 'Tempo Preparazione + Chiusura',
                            data: tempiOperatoriGlobali.map(i => i.tempoTotale - i.tempoChirurgico),
                            backgroundColor: '#95a5a6',
                            borderRadius: 4
                        },
                        {
                            label: 'Tempo Chirurgico Effettivo',
                            data: tempiOperatoriGlobali.map(i => i.tempoChirurgico),
                            backgroundColor: '#e74c3c',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                afterBody: function(context) {
                                    const idx = context[0].dataIndex;
                                    const item = tempiOperatoriGlobali[idx];
                                    const ratio = (item.tempoChirurgico / item.tempoTotale * 100).toFixed(1);
                                    return [
                                        `Tempo totale: ${item.tempoTotale} min`,
                                        `% Chirurgico: ${ratio}%`,
                                        `% Preparazione: ${(100 - ratio).toFixed(1)}%`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: { text: 'Tempo (minuti)' }
                        }
                    }
                }
            });
        }
        
        function creaTempiOperatoriBreakdown() {
            // Ordino per tempo totale crescente per waterfall
            const interventiWaterfall = [...tempiOperatoriGlobali].sort((a, b) => a.tempoTotale - b.tempoTotale);
            
            return creaGrafico('tempiOperatoriBreakdownChart', {
                type: 'bar',
                data: {
                    labels: interventiWaterfall.map(i => i.nome),
                    datasets: [{
                        label: 'Durata Totale Media',
                        data: interventiWaterfall.map(i => i.tempoTotale),
                        backgroundColor: interventiWaterfall.map(i => {
                            const range = i.tempoTotale - i.tempoChirurgico;
                            if (range > 60) return '#e74c3c';
                            if (range > 30) return '#f39c12';
                            return '#27ae60';
                        }),
                        borderRadius: 6,
                        borderWidth: 0.3,
                        borderColor: '#2c3e50'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const item = interventiWaterfall[context.dataIndex];
                                    const preparazione = item.tempoTotale - item.tempoChirurgico;
                                    return [
                                        `Durata media: ${item.tempoTotale} min`,
                                        `Chirurgico: ${item.tempoChirurgico} min`,
                                        `Preparazione: ${preparazione} min`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { text: 'Durata Media (minuti)' }
                        },
                        x: {
                            ticks: { maxRotation: 45 }
                        }
                    }
                }
            });
        }
        
        // ============================
        // Funzioni per creare i grafici - UTILIZZO SALE
        // ============================
        
        function creaUtilizzoSaleConfronto() {
            return creaGrafico('utilizzoSaleConfrontoChart', {
                type: 'bar',
                data: {
                    labels: utilizzoSaleDataGlobale.map(s => `Sala ${s.sala}`),
                    datasets: [
                        {
                            label: 'Prima (con urgenze)',
                            data: utilizzoSaleDataGlobale.map(s => s.precedente),
                            backgroundColor: '#e74c3c',
                            borderRadius: 4
                        },
                        {
                            label: 'Dopo (senza urgenze)',
                            data: utilizzoSaleDataGlobale.map(s => s.pulito),
                            backgroundColor: '#27ae60',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 110,
                            title: { text: 'Utilizzo %' },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function creaUtilizzoSaleFiltro() {
            return creaGrafico('utilizzoSaleFiltroChart', {
                type: 'bar',
                data: {
                    labels: utilizzoSaleDataGlobale.map(s => `Sala ${s.sala}`),
                    datasets: [{
                        label: 'Utilizzo %',
                        data: utilizzoSaleDataGlobale.map(s => s.pulito),
                        backgroundColor: utilizzoSaleDataGlobale.map(s => {
                            if (s.pulito >= 70 && s.pulito <= 90) return '#27ae60';
                            if (s.pulito < 70) return '#f39c12';
                            return '#e74c3c';
                        }),
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { text: 'Utilizzo %' },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function creaUtilizzoSaleTipoIntervento() {
            return creaGrafico('utilizzoSaleTipoInterventoChart', {
                type: 'doughnut',
                data: {
                    labels: tipiInterventoDataGlobale.map(t => t.tipo),
                    datasets: [{
                        data: tipiInterventoDataGlobale.map(t => t.volume),
                        backgroundColor: ['#27ae60', '#f39c12', '#e74c3c', '#9b59b6'],
                        borderWidth: 3,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const item = tipiInterventoDataGlobale[context.dataIndex];
                                    return `${item.tipo}: ${item.volume} (${item.percentuale}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function creaUtilizzoSaleUrgenzeResidue() {
            return creaGrafico('utilizzoSaleUrgenzeResidueChart', {
                type: 'bar',
                data: {
                    labels: urgenzeResidueDataGlobale.map(u => `Sala ${u.sala}`),
                    datasets: [{
                        label: 'Urgenze Residue',
                        data: urgenzeResidueDataGlobale.map(u => u.urgenze),
                        backgroundColor: '#e74c3c',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { text: 'Numero Urgenze' }
                        }
                    }
                }
            });
        }
        
        // ============================
        // Gestione sezione specialità
        // ============================
        
        function selezionaSpecialita(specialtyName) {
            // Aggiorna bottoni attivi
            document.querySelectorAll('.specialty-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-specialty="${specialtyName}"]`).classList.add('active');

            if (specialtyName === 'OVERVIEW') {
                creaSpecialitaOverviewContent();
                return;
            }

            // Ottieni dati specialità
            const data = specialitaDataGlobali[specialtyName];
            if (!data) return;

            // Crea content dashboard
            const content = `
                <div class="selected-specialty-header">
                    <div class="selected-specialty-title">${specialtyName}</div>
                </div>

                <div class="overview-stats">
                    <div class="stat-card">
                        <div class="stat-value">${data.totalCount}</div>
                        <div class="stat-label">Interventi Totali</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.mediaTempi} min</div>
                        <div class="stat-label">Tempo Medio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.variabilitaSpecialita}%</div>
                        <div class="stat-label">Variabilità CV</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.percentage}%</div>
                        <div class="stat-label">% del Totale</div>
                    </div>
                </div>

                <div class="specialty-charts-container">
                    <div class="specialty-chart-wrapper">
                        <div class="specialty-chart-title">Distribuzione Completa</div>
                        <div class="specialty-chart-box">
                            <canvas id="specialitaPieChart_${specialtyName.replace(/\s+/g, '_')}"></canvas>
                        </div>
                    </div>
                    <div class="specialty-chart-wrapper">
                        <div class="specialty-chart-title">Top Interventi</div>
                        <div class="specialty-chart-box">
                            <canvas id="specialitaFrequencyChart_${specialtyName.replace(/\s+/g, '_')}"></canvas>
                        </div>
                    </div>
                    <div class="specialty-chart-wrapper">
                        <div class="specialty-chart-title">Complessità</div>
                        <div class="specialty-chart-box">
                            <canvas id="specialitaComplexityChart_${specialtyName.replace(/\s+/g, '_')}"></canvas>
                        </div>
                    </div>
                </div>

                <div class="info-cards">
                    <div class="info-card">
                        <div class="info-title">Copertura Analisi</div>
                        <div class="info-content">Top 6 interventi mostrati: <strong>${data.topInterventions.reduce((sum, i) => sum + i.count, 0)} casi (${((data.topInterventions.reduce((sum, i) => sum + i.count, 0) / data.totalCount) * 100).toFixed(1)}%)</strong><br>
                        Altri interventi: <strong>${data.totalCount - data.topInterventions.reduce((sum, i) => sum + i.count, 0)} casi non mostrati in dettaglio</strong></div>
                    </div>
                    <div class="info-card">
                        <div class="info-title">Classificazione Complessità</div>
                        <div class="info-content"><strong>Basata su tempi operatori:</strong><br>
                        Bassa &lt;80min | Media 80-120min<br>
                        Alta 120-180min | Molto Alta &gt;180min</div>
                    </div>
                </div>

                <div class="interventions-table">
                    <div class="table-header">
                        Top Interventi - ${specialtyName}
                    </div>
                    <div class="table-content">
                        <div class="row-header">
                            <div>Intervento</div>
                            <div>Casi</div>
                            <div>Tempo Medio</div>
                            <div>Variabilità</div>
                            <div>Complessità</div>
                        </div>
                        ${data.topInterventions.map((intervention, index) => `
                            <div class="intervention-row">
                                <div class="intervention-name">
                                    ${intervention.nome.length > 60 ? intervention.nome.substring(0, 57) + '...' : intervention.nome}
                                </div>
                                <div class="intervention-metric">
                                    <strong>${intervention.count}</strong><br>
                                    <small>(${intervention.percentage}%)</small>
                                </div>
                                <div class="intervention-metric">
                                    <strong>${intervention.tempoMedio} min</strong>
                                </div>
                                <div class="intervention-metric">
                                    <span class="cv-indicator ${intervention.cv >= 40 ? 'cv-high' : intervention.cv >= 25 ? 'cv-medium' : 'cv-low'}">
                                        ${intervention.cv}% CV
                                    </span>
                                </div>
                                <div class="intervention-metric">
                                    <span class="complexity-badge complexity-${intervention.complessita.toLowerCase().replace(' ', '-')}">
                                        ${intervention.complessita}
                                    </span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            const dashboardContent = document.getElementById('specialtyDashboardContent');
            dashboardContent.innerHTML = content;
            dashboardContent.classList.add('active');

            // Distruggi grafici precedenti della sezione specialità
            const canvasIds = [
                `specialitaPieChart_${specialtyName.replace(/\s+/g, '_')}`,
                `specialitaFrequencyChart_${specialtyName.replace(/\s+/g, '_')}`,
                `specialitaComplexityChart_${specialtyName.replace(/\s+/g, '_')}`
            ];
            
            canvasIds.forEach(id => distruggiGrafico(id));

            // Aspetta che il DOM sia aggiornato, poi crea i grafici
            requestAnimationFrame(() => {
                creaSpecialitaPieChart(data, specialtyName);
                creaSpecialitaFrequencyChart(data, specialtyName);
                creaSpecialitaComplexityChart(data, specialtyName);
            });
        }

        function creaSpecialitaPieChart(data, specialtyName) {
            const chartId = `specialitaPieChart_${specialtyName.replace(/\s+/g, '_')}`;
            
            // Prepara dati per torta ottimizzata
            const topCount = data.topInterventions.reduce((sum, i) => sum + i.count, 0);
            const othersCount = data.totalCount - topCount;
            
            // Raggruppa interventi: mostra top 4, raggruppa il resto in "Altri top" e "Altri"
            const pieData = [];
            const pieLabels = [];
            const pieColors = [];
            
            // Top 4 interventi
            data.topInterventions.slice(0, 4).forEach(intervention => {
                pieData.push(intervention.count);
                pieLabels.push(intervention.nome.length > 25 ? intervention.nome.substring(0, 22) + '...' : intervention.nome);
                if (intervention.complessita === 'Molto Alta') pieColors.push('#e74c3c');
                else if (intervention.complessita === 'Alta') pieColors.push('#e67e22');
                else if (intervention.complessita === 'Media') pieColors.push('#f39c12');
                else pieColors.push('#27ae60');
            });
            
            // Altri top (se ci sono più di 4)
            if (data.topInterventions.length > 4) {
                const otherTopCount = data.topInterventions.slice(4).reduce((sum, i) => sum + i.count, 0);
                pieData.push(otherTopCount);
                pieLabels.push(`Altri Top (${data.topInterventions.length - 4} tipologie)`);
                pieColors.push('#95a5a6');
            }
            
            // Altri non mostrati
            if (othersCount > 0) {
                pieData.push(othersCount);
                pieLabels.push(`Altri interventi`);
                pieColors.push('#bdc3c7');
            }

            return creaGrafico(chartId, {
                type: 'doughnut',
                data: {
                    labels: pieLabels,
                    datasets: [{
                        data: pieData,
                        backgroundColor: pieColors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value} casi (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function creaSpecialitaFrequencyChart(data, specialtyName) {
            const chartId = `specialitaFrequencyChart_${specialtyName.replace(/\s+/g, '_')}`;
            
            return creaGrafico(chartId, {
                type: 'bar',
                data: {
                    labels: data.topInterventions.map(i => 
                        i.nome.length > 25 ? i.nome.substring(0, 22) + '...' : i.nome
                    ),
                    datasets: [{
                        label: 'Numero Casi',
                        data: data.topInterventions.map(i => i.count),
                        backgroundColor: data.topInterventions.map(i => {
                            if (i.complessita === 'Molto Alta') return '#e74c3c';
                            if (i.complessita === 'Alta') return '#e67e22';
                            if (i.complessita === 'Media') return '#f39c12';
                            return '#27ae60';
                        }),
                        borderRadius: 6,
                        maxBarThickness: 50
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Numero Casi'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function creaSpecialitaComplexityChart(data, specialtyName) {
            const chartId = `specialitaComplexityChart_${specialtyName.replace(/\s+/g, '_')}`;
            
            // Calcola categorie complessità dai dati
            const categorieComplessita = {};
            data.topInterventions.forEach(intervention => {
                const comp = intervention.complessita;
                if (categorieComplessita[comp]) {
                    categorieComplessita[comp] += intervention.count;
                } else {
                    categorieComplessita[comp] = intervention.count;
                }
            });

            return creaGrafico(chartId, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categorieComplessita),
                    datasets: [{
                        data: Object.values(categorieComplessita),
                        backgroundColor: Object.keys(categorieComplessita).map(comp => {
                            if (comp === 'Molto Alta') return '#e74c3c';
                            if (comp === 'Alta') return '#e67e22';
                            if (comp === 'Media') return '#f39c12';
                            return '#27ae60';
                        }),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value} casi (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function creaSpecialitaOverviewContent() {
            const content = `
                <div class="selected-specialty-header">
                    <div class="selected-specialty-title">Overview Generale</div>
                </div>

                <div class="overview-stats">
                    <div class="stat-card">
                        <div class="stat-value">455</div>
                        <div class="stat-label">Interventi Totali</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">5</div>
                        <div class="stat-label">Specialità</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">91 min</div>
                        <div class="stat-label">Tempo Medio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">35</div>
                        <div class="stat-label">Giorni Analisi</div>
                    </div>
                </div>

                <div class="specialty-charts-container">
                    <div class="specialty-chart-wrapper">
                        <div class="specialty-chart-title">Distribuzione Specialità</div>
                        <div class="specialty-chart-box">
                            <canvas id="overviewSpecialitaChart"></canvas>
                        </div>
                    </div>
                    <div class="specialty-chart-wrapper">
                        <div class="specialty-chart-title">Tempi Medi per Specialità</div>
                        <div class="specialty-chart-box">
                            <canvas id="overviewTimingChart"></canvas>
                        </div>
                    </div>
                    <div class="specialty-chart-wrapper">
                        <div class="specialty-chart-title">Variabilità per Specialità</div>
                        <div class="specialty-chart-box">
                            <canvas id="overviewVariabilitaChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="info-cards">
                    <div class="info-card">
                        <div class="info-title">Insight Principali</div>
                        <div class="info-content"><strong>UROLOGIA</strong> è la specialità dominante (34.3%)<br>
                        <strong>OTORINOLARINGOIATRIA</strong> ha il minor volume (8.6%)<br>
                        Variabilità media del sistema: <strong>59% CV</strong></div>
                    </div>
                    <div class="info-card">
                        <div class="info-title">Criticità Identificate</div>
                        <div class="info-content"><strong>Alta variabilità:</strong> 4/5 specialità >50% CV<br>
                        <strong>Range tempi:</strong> 29-268 minuti<br>
                        <strong>Standardizzazione:</strong> necessaria per efficienza</div>
                    </div>
                </div>

                <div class="interventions-table">
                    <div class="table-header">
                        Confronto Specialità
                    </div>
                    <div class="table-content">
                        <div class="row-header">
                            <div>Specialità</div>
                            <div>Volume</div>
                            <div>Tempo Medio</div>
                            <div>Variabilità</div>
                            <div>Performance</div>
                        </div>
                        <div class="intervention-row">
                            <div class="intervention-name">UROLOGIA</div>
                            <div class="intervention-metric"><strong>156</strong><br><small>(34.3%)</small></div>
                            <div class="intervention-metric"><strong>91 min</strong></div>
                            <div class="intervention-metric"><span class="cv-indicator cv-high">75% CV</span></div>
                            <div class="intervention-metric"><span class="complexity-badge complexity-alta">Leader Volume</span></div>
                        </div>
                        <div class="intervention-row">
                            <div class="intervention-name">ORTOPEDIA E TRAUMATOLOGIA</div>
                            <div class="intervention-metric"><strong>104</strong><br><small>(22.9%)</small></div>
                            <div class="intervention-metric"><strong>102 min</strong></div>
                            <div class="intervention-metric"><span class="cv-indicator cv-medium">41% CV</span></div>
                            <div class="intervention-metric"><span class="complexity-badge complexity-media">Migliore Variabilità</span></div>
                        </div>
                        <div class="intervention-row">
                            <div class="intervention-name">OSTETRICIA E GINECOLOGIA</div>
                            <div class="intervention-metric"><strong>83</strong><br><small>(18.2%)</small></div>
                            <div class="intervention-metric"><strong>81 min</strong></div>
                            <div class="intervention-metric"><span class="cv-indicator cv-high">62% CV</span></div>
                            <div class="intervention-metric"><span class="complexity-badge complexity-bassa">Tempo Minimo</span></div>
                        </div>
                        <div class="intervention-row">
                            <div class="intervention-name">CHIRURGIA GENERALE</div>
                            <div class="intervention-metric"><strong>73</strong><br><small>(16.0%)</small></div>
                            <div class="intervention-metric"><strong>88 min</strong></div>
                            <div class="intervention-metric"><span class="cv-indicator cv-high">52% CV</span></div>
                            <div class="intervention-metric"><span class="complexity-badge complexity-media">Equilibrata</span></div>
                        </div>
                        <div class="intervention-row">
                            <div class="intervention-name">OTORINOLARINGOIATRIA</div>
                            <div class="intervention-metric"><strong>39</strong><br><small>(8.6%)</small></div>
                            <div class="intervention-metric"><strong>82 min</strong></div>
                            <div class="intervention-metric"><span class="cv-indicator cv-high">63% CV</span></div>
                            <div class="intervention-metric"><span class="complexity-badge complexity-molto-alta">Specialistica</span></div>
                        </div>
                    </div>
                </div>
            `;

            const dashboardContent = document.getElementById('specialtyDashboardContent');
            dashboardContent.innerHTML = content;
            dashboardContent.classList.add('active');

            // Distruggi grafici precedenti
            ['overviewSpecialitaChart', 'overviewTimingChart', 'overviewVariabilitaChart'].forEach(id => {
                distruggiGrafico(id);
            });

            // Crea charts overview
            requestAnimationFrame(() => {
                creaSpecialitaOverviewCharts();
            });
        }

        function creaSpecialitaOverviewCharts() {
            // Chart 1: Distribuzione Specialità
            const specialtyData = Object.keys(specialitaDataGlobali).map(key => ({
                name: key,
                count: specialitaDataGlobali[key].totalCount
            }));

            creaGrafico('overviewSpecialitaChart', {
                type: 'doughnut',
                data: {
                    labels: specialtyData.map(s => s.name),
                    datasets: [{
                        data: specialtyData.map(s => s.count),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });

            // Chart 2: Tempi Medi
            const timingData = Object.keys(specialitaDataGlobali).map(key => ({
                name: key.length > 15 ? key.substring(0, 12) + '...' : key,
                time: specialitaDataGlobali[key].mediaTempi
            }));

            creaGrafico('overviewTimingChart', {
                type: 'bar',
                data: {
                    labels: timingData.map(s => s.name),
                    datasets: [{
                        label: 'Tempo Medio (min)',
                        data: timingData.map(s => s.time),
                        backgroundColor: '#667eea',
                        borderRadius: 6,
                        maxBarThickness: 50
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Minuti'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });

            // Chart 3: Variabilità
            const variabilityData = Object.keys(specialitaDataGlobali).map(key => ({
                name: key.length > 15 ? key.substring(0, 12) + '...' : key,
                variability: specialitaDataGlobali[key].variabilitaSpecialita
            }));

            creaGrafico('overviewVariabilitaChart', {
                type: 'bar',
                data: {
                    labels: variabilityData.map(s => s.name),
                    datasets: [{
                        label: 'Variabilità CV%',
                        data: variabilityData.map(s => s.variability),
                        backgroundColor: variabilityData.map(s => 
                            s.variability >= 60 ? '#e74c3c' : 
                            s.variability >= 50 ? '#f39c12' : '#27ae60'
                        ),
                        borderRadius: 6,
                        maxBarThickness: 50
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'CV%'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }
        
        // ============================
        // Inizializzazione dashboard
        // ============================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Navigazione tra sezioni
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.section').forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    const target = this.getAttribute('data-target');
                    document.getElementById(target).style.display = 'block';
                });
            });
            
            // Mostra la sezione panoramica all'avvio
            document.getElementById('overview').style.display = 'block';
        
            // Crea i grafici della panoramica
            creaPanoramicaSpecialitaDistribuzione();
            creaPanoramicaTempiMediSpecialita();
            
            // Genera la heatmap
            generaHeatmapTabella();
            
            // Crea i grafici della sezione heatmap
            creaHeatmapCaricoSettimanaleSpecialita();
            creaHeatmapUtilizzoSaleSpecialita();
            
            // Crea i grafici della sezione operativa
            creaTurnoverDistribuzioneFasce();
            creaTurnoverMedioSaleOperatorie();
            creaTurnoverNumeroPerSala();
            creaTurnoverIstogrammaDistribuzione();
            creaTimingDistribuzioneOrari();
            creaTimingDettaglioFasciaMattutinaChart();
            creaTimingRitardiProgrammazione();
            creaTempiOperatoriMediTotaleChirurgico();
            creaTempiOperatoriRangeMinMax();
            creaTempiOperatoriComposizione();
            creaTempiOperatoriBreakdown();
            creaUtilizzoSaleConfronto();
            creaUtilizzoSaleFiltro();
            creaUtilizzoSaleTipoIntervento();
            creaUtilizzoSaleUrgenzeResidue();
            
            // Gestione interattività della sezione specialità
            document.querySelectorAll('.specialty-button').forEach(button => {
                button.addEventListener('click', function() {
                    selezionaSpecialita(this.dataset.specialty);
                });
            });
            
            // Imposta stato iniziale sezione specialità
            document.querySelector('.specialty-button[data-specialty="OVERVIEW"]').classList.add('active');
            creaSpecialitaOverviewContent();
        });
    </script>
</body>

</html>
